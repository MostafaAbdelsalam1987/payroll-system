import { NextApiRequest, NextApiResponse } from "next";
import { prisma } from "@/lib/prisma";
import { verifyToken } from "../../../../middleware/auth";

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== "POST") {
    return res.status(405).json({ message: "Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø©" });
  }

  try {
    const user = await verifyToken(req, res);
    if (!user) {
      return res.status(401).json({ message: "ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„" });
    }

    console.log("ğŸ”¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠØ­Ø§ÙˆÙ„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", user);

    // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø­Ø§Ø³Ø¨ ÙˆØ§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
    const allowedRoles = ["Ù…Ø­Ø§Ø³Ø¨", "Ù…Ø¯ÙŠØ± Ù…Ø§Ù„ÙŠ", "accountant", "finance_manager"];
    if (!allowedRoles.includes(user.role)) {
      console.error("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:", user.role);
      return res.status(403).json({ message: "ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙˆØ§ØªÙŠØ±" });
    }

    const { clientId, month, year, amount } = req.body;

    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø±Ø³Ù„Ø©
    if (!clientId || !month || !year || !amount) {
      console.error("âŒ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©:", { clientId, month, year, amount });
      return res.status(400).json({ message: "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©" });
    }

    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯
    const client = await prisma.client.findUnique({ where: { id: Number(clientId) } });
    if (!client) {
      console.error("âŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:", clientId);
      return res.status(404).json({ message: "Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
    }

    // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    const invoice = await prisma.invoice.create({
      data: {
        clientId: Number(clientId),
        month: Number(month),
        year: Number(year),
        amount: Number(amount),
        isPaid: false, // âœ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªØ¨Ø¯Ø£ ÙƒØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©
      },
    });

    console.log("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­:", invoice);

    // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø­Ø§Ø³Ø¨
    await prisma.notification.create({
      data: {
        userId: user.id, // Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ø°ÙŠ Ø£Ø¶Ø§Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        messageAr: `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ ${client.nameAr} Ø¨Ù…Ø¨Ù„Øº ${amount} Ø±ÙŠØ§Ù„.`,
        messageEn: `A new invoice has been added for client ${client.nameEn} with an amount of ${amount} SAR.`,
        isRead: false,
      },
    });

    return res.status(201).json({ message: "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­", invoice });
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", error);
    return res.status(500).json({ message: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø©" });
  }
}
